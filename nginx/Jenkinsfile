pipeline {
    agent {
        kubernetes {
            label 'docker-agent'
            yaml """
apiVersion: v1
kind: Pod
spec:
  containers:
  - name: jnlp
    image: jenkins/inbound-agent:latest-jdk17
    resources:
      requests:
        memory: "256Mi"
        cpu: "100m"
      limits:
        memory: "512Mi"
        cpu: "500m"
  - name: docker
    image: docker:latest
    command: ["cat"]
    tty: true
    securityContext:
      privileged: true
    volumeMounts:
      - name: docker-sock
        mountPath: /var/run/docker.sock
      - name: docker-bin
        mountPath: /usr/bin/docker
  volumes:
  - name: docker-sock
    hostPath:
      path: /var/run/docker.sock
  - name: docker-bin
    hostPath:
      path: /usr/bin/docker
"""
        }
    }
    
    environment {
        REGISTRY = 'docker.io'
        IMAGE_NAME = 'nginx-test'
        IMAGE_TAG = "${env.BUILD_NUMBER}"
    }
    
    stages {
        stage('Clone Source') {
            steps {
                checkout scm
            }
        }
        
        stage('Build & Push Image') {
            steps {
                container('docker') {
                    script {
                        withCredentials([
                            usernamePassword(
                                credentialsId: 'cbc0d5e2-33f3-4ef9-8fff-05432f02dfaa',
                                usernameVariable: 'DOCKER_USER',
                                passwordVariable: 'DOCKER_PASS'
                            )
                        ]) {
                            def fullNEWImage = "${DOCKER_USER}/${IMAGE_NAME}:${IMAGE_TAG}"
                            def fullLastImage = "${DOCKER_USER}/${IMAGE_NAME}:latest"

                            sh """
                                //docker login -u ${DOCKER_USER} -p ${DOCKER_PASS} ${REGISTRY}
                                echo "${DOCKER_PASS}" | docker login -u "${DOCKER_USER}" --password-stdin
                                docker build --build-arg ${REGISTRY} -f ./nginx/Dockerfile -t ${fullNEWImage} -t ${fullLastImage} .
                                docker push ${fullNEWImage}
                                docker push ${fullLastImage}
                            """
                        }
                    }
                }
            }
        }
        
        stage('Update Deployment') {
            steps {
                script {
                    dir('deployment-config') {                    
                        // 提交并推送变更
                       withCredentials([
                           usernamePassword(
                               credentialsId: 'b03f9ac5-8f56-439b-a32a-6837b400ade5',
                               usernameVariable: 'GIT_USER',
                               passwordVariable: 'GIT_PASS'
                           )
                     ]) {
                           def gitRepoUrl = 'https://github.com/freewenxiao/yexiangfeng.git'
                           def secureRepoUrl = "https://${GIT_USER}:${GIT_PASS}@github.com/freewenxiao/yexiangfeng.git"
                           def fullImage = "freewenxiao/${IMAGE_NAME}:${IMAGE_TAG}"
                    
                           sh """
                              git clone ${gitRepoUrl}
                              cd yexiangfeng
                              sed -i "s|image:.*|image: ${fullImage}|" ./nginx/manifests/deployment.yaml

                              git config user.email "jenkins@example.com"
                              git config user.name "Jenkins"
                              git status
                              git add .
                              git commit -m 'Update image to ${IMAGE_TAG}'
                              git push ${secureRepoUrl} master
                              git log -1
                           """
                    }
                }
            }
        }
    }
 }       
    
    post {
        always {
            container('docker') {
                script {
                    // 清理 Docker 登录凭证
                    sh 'docker logout ${REGISTRY} || true'
                    
                    // 清理工作空间
                    deleteDir()
                }
            }
        }
        
        success {
            echo 'Pipeline completed successfully!'
        }
        
        failure {
            echo 'Pipeline failed! Check logs for details.'
        }
    }
}
